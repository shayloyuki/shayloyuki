---
title: "二次封装导入组件"
date: 2022-10-08
categories:
  - blog
tags:
  - Element-Ui
  - Components
---

# 需求

根据 Element-Ui 组件库，二次封装导入组件，包含以下功能：

1. 上传文件按钮；
2. 若有需要，可实时显示导入进度。

# 分析

1. 后端给了两个接口：一是上传文件的接口 `A`，二是查询导入进度的接口 `B`。
    
    > 注意：需要显示的是导入数据库的进度，而不是上传文件的进度，二者是不同的。
    
2. 轮询时机：
   >*不是接口 `A` 调用成功后才轮询接口 `B`，这样会导致无法实时显示进度。*
    **正确做法是：调用 `A` 接口的同时，就开始轮询 `B` 接口，一旦导入进度为 `100%` 就停止轮询，显示导入成功。**

    A接口的触发时间点是点击导入按钮时，那么就在 `data` 中声明 `isUploading` 正在导入状态，调用A接口的时候就开始轮询B接口。

    ![image](https://img2022.cnblogs.com/blog/2399063/202209/2399063-20220902095818379-678630066.png)

    ![image](https://img2022.cnblogs.com/blog/2399063/202209/2399063-20220902095900091-896148240.png)

    ![image](https://img2022.cnblogs.com/blog/2399063/202209/2399063-20220902095958901-803588697.png)

3. 坑：进度条不显示导入成功。
    >进度条等不到显示 `100% 导入成功`就会消失的原因是：之前在调用接口 `A` 成功后就设置 `isUploading = false`，而此时还在轮询接口 `B`，`percentage` 还不到100。
    
      ![image](https://img2022.cnblogs.com/blog/2399063/202209/2399063-20220902100238400-1288645412.png)

      **解决办法：在 `percentage` 达到100之后，再设置 `isUploading = false` 令进度条消失。**

      **注意：在让进度条消失之前，要先清除轮询定时器，并且过1秒钟再让进度条消失（这样会让完成画面定格在界面上一会儿，提示用户）。**

      ![image](https://img2022.cnblogs.com/blog/2399063/202210/2399063-20221008112438335-1007713834.png)


4. 把两个接口封装在组件的 `js` 文件内，这样使用该组件时只需要传入接口地址即可，不需重复书写封装接口代码。

# 解决办法

## 主页面

<details>
<summary>主页面 HTML</summary>

```html
        <el-col :span="1.5">
          <!-- 上传按钮 -->
          <import
            :para-name="paraName"
            :upload-url="uploadUrl"
            :show-file-list="showFileList"
            :file-type="fileType"
            :btn-permi="btnPermi"
            @refreshList="loadxxxxList"
            :progress-url="progressUrl"
          />
        </el-col>
```
</details>

<details>
<summary>主页面 data 声明</summary>

```js
      // 是否显示文件列表
      showFileList: false,
      // 文件类型
      fileType: ['zip'],
      // 按钮权限
      btnPermi: ['xxxx:xxx:xxxx'],
      // 上传文件的参数名称
      paraName: 'zipFile',
      // 上传文件地址
      uploadUrl: "/xxxx/uploadFile",
      // 查询导入进度地址
      progressUrl: "/xxxx/progress",
```
</details>

------------

## 导入组件

<details>
<summary>导入组件 Import/index.vue HTML</summary>

```html
  <div class="import">
    <!-- 导入进度组件  -->
    <el-progress
      v-if="progressUrl && isUploading"
      class="upload-progress"
      type="circle"
      :percentage="percentage"
      :status="percentage === 100 ? 'success' : null"
      :format="format"
    />
    <!-- 导入组件 -->
    <el-upload
      element-loading-text=""
      element-loading-spinner="null"
      v-loading.fullscreen.lock="progressUrl && isUploading"
      element-loading-background="rgba(0, 0, 0, 0.8)"
      class="upload-file"
      ref="upload"
      :action="uploadUrl"
      :http-request="uploadFile"
      :show-file-list="showFileList"
      multiple
      :accept="acceptText"
      :on-exceed="handleExceed"
      :before-upload="beforeUpload"
      :limit="limitNum"
      :file-list="fileList"
      >
        <el-button type="warning" :plain="isPlain" icon="el-icon-upload2" size="mini">导入</el-button>
        <div slot="tip" class="el-upload__tip">请导入 <b>{{ fileType.join('、') }}</b> 文件</div>
    </el-upload>    
  </div>
```
</details>

<details>
<summary>导入组件 Import/index.vue JS</summary>

```js
import { importFile } from './importFile'
import { queryProgress } from './progress'

export default {
  name: 'Import',
  data() {
    return {
      // 导入的文件
      file: {},
      // 导入成功的文件列表
      fileList: [],
      // 正在导入状态
      isUploading: false,
      // 导入进度的百分比数字
      percentage: 0,
      // 轮询定时器
      loopTimer: '',
    }
  },
  props: {
    // 导入按钮的样式
    isPlain: {
      type: Boolean,
      default: true
    },
    // 导入文件的参数名称
    paraName: {
      type: String,
      default: 'file'      
    },
    // 导入文件的地址
    uploadUrl: {
      type: String,
      default: ''
    },
    // 是否显示文件列表
    showFileList: {
      type: Boolean,
      default: true
    },
    // 文件类型
    fileType: {
      type: Array,
      default: () => ['zip']
    },
    // 文件大小
    fileSize: {
      type: Number,
      default: 10
    },
    // 导入文件数量
    limitNum: {
      type: Number,
      default: 20
    },
    // 按钮权限
    btnPermi: {
      type: Array
    },
    // 查询导入进度的地址：若无，表示不加载导入进度
    progressUrl: {
      type: String
    }
  },
  watch: {
    // 监听导入状态：开始导入就开始轮询
    isUploading(newVal) {
      if (newVal && this.progressUrl) {
        this.loopProgress()
      }
    },
    // 监听导入进度：清除定时器、隐藏进度条
    percentage(newVal) {
      if (newVal >= 100) {
        window.clearInterval(this.loopTimer)
        setTimeout(() => {
          if (this.percentage = 0) return // 避免因为网络阻塞请求延迟，多次监听
          this.isUploading = false 
          this.percentage = 0 
          this.$message.success('导入成功') 
          this.fileChange(this.file)
          this.$emit('refreshList')          
        }, 1000)       
      }
    }
  },
  computed: {
    acceptText() {
      return this.fileType.map(ele => '.' + ele).join(',')
    }
  },
  methods: {
    // 进度条内文字
    format(percentage) {
      let text = percentage === 100 ? '导入成功' : '导入中'
      return percentage + '%\n' + text
    },
    /* 自定义导入文件 */
    async uploadFile(param) {
      this.file = param.file
      this.isUploading = true
      const formData = new FormData()
      formData.append(this.paraName, this.file)
      if (!this.uploadUrl) { return console.log('uploadUrl 为空') }
      const data = await importFile(formData, this.uploadUrl)
      if (data.code === 200) {
        if (!this.progressUrl) {
          this.isUploading = false
          this.$message.success('上传成功')
          this.fileChange(this.file)
          this.$emit('refreshList')
        }
      } else {
        this.isUploading = false
        this.$message.error('上传失败')
        console.log('上传失败')
      }
    },
    /* 导入文件改变触发的函数 */
    fileChange(file){
      this.$refs.upload.clearFiles()
      this.fileList = [{name: file.name, zipFile: file}]
    },
    /* 校验导入文件的数量 */
    handleExceed(files, fileList) {
      this.$message.warning(`当前限制选择 ${this.limitNum} 个文件，本次选择了 ${files.length} 个文件，共选择了 ${files.length + fileList.length} 个文件`);
    },
    /* 导入文件前校验格式和大小 */
    beforeUpload(file) {
      const fileSuffix = file.name.substring(file.name.lastIndexOf('.') + 1)
      const isType = this.fileType.includes(fileSuffix)
      const isLimit = file.size / 1024 / 1024 <= this.fileSize
      if (!isType) {
        this.$message.error(`导入文件只能是 ${this.fileType.join('、')} 格式`);
      }
      if (!isLimit) {
        this.$message.error(`导入文件大小不能超过 ${this.fileSize}MB`);
      }
      return isType && isLimit
    },
    /* 查询导入进度 */
    async getProgress() {
      const data = await queryProgress(this.progressUrl)
      if (data.code === 200) {
        const num = data.data.percent
        this.percentage = num
      } else {
        this.$message.error('查询进度失败')
      }
    },
    /* 轮询导入进度 */
    loopProgress() {
      this.loopTimer = window.setInterval(() => {
        setTimeout(async () => {
          // 调用接口
          this.getProgress()
        }, 0)
      }, 1000)

    }
  }
}
```
</details>

<details>
<summary>导入组件 Import/index.vue SCSS</summary>

```scss
// 导入文件类型
.el-upload__tip b {
  color: red;
}

// 进度条
.upload-progress {
  position: fixed;
  left: 50%;
  top: 180px;
  margin-left: -63px;
  z-index: 20000;
}
```
</details>

<details>
<summary>导入组件 Import/importFile.js</summary>

```js
import request from '@/utils/request'

// 导入文件
export const importFile = (data, importUrl) => {
  return request({
    url: importUrl,
    method: 'post',
    data,
    headers:{"Content-Type" : "multipart/form-data;boundary ="+ new Date().getTime()},
  })
}
```
</details>

<details>
<summary>导入组件 Import/progress.js</summary>

```js
import request from '@/utils/request'

export const queryProgress = (progressUrl) => {
  return request({
    url: progressUrl,
    method: 'get'
  })
}
```
</details>

# 总结

1. 传递接口地址给组件，提高封装组件的灵活性；
2. `el-upload` 组件，采用  `http-request` 自定义上传方式。上传接口是数据格式是  `multipart/form-data` 时，要单独设置 `Content-Type`，传参也要转为 `formdata` 格式，`formData.append(参数名, this.file)`；
3. `el-progress` 自定义显示数据使用 `format`属性；
4. 轮询导入进度：`window.setInterval(() => {setTimeout(() => {// 调用接口}, 0)}, 1000)`。清除定时器：`clearInterval(定时器名称)`。


# 参考链接

1. [封装upLoad组件，自定义上传方法](https://juejin.cn/post/7031884699115094053 "封装upLoad组件，自定义上传方法")
2. [element-ui中 Progress 圆形进度条 自定义文字 底色 圆角 文字颜色等修改](https://blog.csdn.net/weixin_45045099/article/details/125891783?spm=1001.2101.3001.6650.6&utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-6-125891783-blog-106373868.t0_searchtargeting_v1&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-6-125891783-blog-106373868.t0_searchtargeting_v1&utm_relevant_index=7 "element-ui中 Progress 圆形进度条 自定义文字 底色 圆角 文字颜色等修改")
3. [element的遮罩层v-loading，隐藏上面的文字和图标，添加自定义内容](https://blog.csdn.net/qq_42376171/article/details/124591090?ops_request_misc=&request_id=&biz_id=102&utm_term=v-loading%20%E8%87%AA%E5%AE%9A%E4%B9%89%E6%A0%B7%E5%BC%8F&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-8-124591090.142%5ev42%5epc_ran_alice,185%5ev2%5etag_show&spm=1018.2226.3001.4187 "element的遮罩层v-loading，隐藏上面的文字和图标，添加自定义内容")